
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Rundown of ansible-sign (CLI) usage &#8212; ansible-sign 0.0.post1.dev1+gac3d747 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Changelog" href="changelog.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="rundown-of-ansible-sign-cli-usage">
<h1>Rundown of <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> (CLI) usage<a class="headerlink" href="#rundown-of-ansible-sign-cli-usage" title="Permalink to this heading">¶</a></h1>
<p>For Ansible Automation Platform content developers (project maintainers), the
primary and supported way of using <strong>ansible-sign</strong> is through the command-line
interface that comes with it.</p>
<p>The command-line interface aims to make it easy to use cryptographic technology
like GPG to validate that specified files within a project have not been
tampered with in any way.</p>
<p>Though in the future other means of signing and validating might be supported,
GPG is the only currently supported means of signing and validation. As such, the
rest of this tutorial assumes the use of GPG.</p>
<p>The process of creating a GPG public/private keypair for signing content is well
documented online, such as in this <a class="reference external" href="https://www.redhat.com/sysadmin/creating-gpg-keypairs">Red Hat “Enable Sysadmin” blog post</a>. As
such, we will assume that you have a valid GPG keypair already available and in
your default GnuPG keyring.</p>
<p>You can verify that you have a keypair with the following command:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Verifying that a valid secret GPG key exists for signing content</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gpg --list-secret-keys
</pre></div>
</div>
</div>
<p>If the above command produces no output, or one line of output that says that a
“trustdb” was created, then you do not have a secret key in your default
keyring. In this case, refer to the aforementioned blog post to learn how to create a new keypair.</p>
<p>If it produces output other than that, then you have a valid secret key
and are ready to move on to
<a class="reference internal" href="#ansible-sign-install"><span class="std std-ref">using ansible-sign</span></a>.</p>
<section id="adding-a-gpg-key-to-awx-or-ansible-automation-controller">
<h2>Adding a GPG key to AWX or Ansible Automation Controller<a class="headerlink" href="#adding-a-gpg-key-to-awx-or-ansible-automation-controller" title="Permalink to this heading">¶</a></h2>
<p>In the command line, run the following commands:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ gpg --list-keys
$ gpg --export --armour &lt;key fingerprint&gt; &gt; my_public_key.asc
</pre></div>
</div>
<ol class="arabic simple">
<li><p>In AWX/Automation Controller, click “Credentials” then the “Add” button</p></li>
<li><p>Give the new credential a meaningful name (for example, “infrastructure team public GPG key”)</p></li>
<li><p>For “Credential Type” select “GPG Public Key”</p></li>
<li><p>Click “Browse” to navigate to and select the file that you created earlier (<code class="docutils literal notranslate"><span class="pre">my_public_key.asc</span></code>)</p></li>
<li><p>Finally, click the “Save” button to finish</p></li>
</ol>
<p>This credential can now be selected in “Project” settings. Once selected, content verification will automatically take place on future project syncs.</p>
<p>Vist <a class="reference external" href="https://www.gnupg.org/documentation/index.html">the GnuPG documentation</a> for more information regarding GPG keys.
For more information regarding generating a GPG keypair, visit the <a class="reference external" href="https://www.redhat.com/sysadmin/creating-gpg-keypairs">Red Hat “Enable Sysadmin” blog post</a>.</p>
</section>
<section id="how-to-access-the-ansible-sign-cli-utility">
<span id="ansible-sign-install"></span><h2>How to Access the <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> CLI Utility<a class="headerlink" href="#how-to-access-the-ansible-sign-cli-utility" title="Permalink to this heading">¶</a></h2>
<p>Run the following command to install <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code>:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Installing <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code></span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ pip install ansible-sign
</pre></div>
</div>
</div>
<p>Once it’s installed, run:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Verify that <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> was successfully installed.</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ansible-sign --version
</pre></div>
</div>
</div>
<p>You should see output similar to the following (possibly with a different version number):</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">The output of <code class="docutils literal notranslate"><span class="pre">ansible-sign</span> <span class="pre">--version</span></code></span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ansible-sign <span class="m">0</span>.1
</pre></div>
</div>
</div>
<p>Congratulations! You have successfully installed <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code>!</p>
</section>
<section id="the-project-directory">
<h2>The Project Directory<a class="headerlink" href="#the-project-directory" title="Permalink to this heading">¶</a></h2>
<p>We will start with a simple Ansible project directory. The <a class="reference external" href="https://docs.ansible.com/ansible/latest/user_guide/sample_setup.html">Ansible
documentation</a> goes into more sophisticated examples of project directory
structures.</p>
<p>In our sample project, we have a very simple structure. An <code class="docutils literal notranslate"><span class="pre">inventory</span></code> file,
and two small playbooks under a <code class="docutils literal notranslate"><span class="pre">playbooks</span></code> directory.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Our sample project</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> sample-project/
$ tree -a .
.
├── inventory
└── playbooks
    ├── get_uptime.yml
    └── hello.yml

<span class="m">1</span> directory, <span class="m">3</span> files
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Future commands that we run will assume that your Working Directory is the
root of your project. <code class="docutils literal notranslate"><span class="pre">ansible-sign</span> <span class="pre">project</span></code> commands, as a rule, always
take the project root directory as their last argument, thus we will simply
use <code class="docutils literal notranslate"><span class="pre">.</span></code> to indicate the current Working Directory.</p>
</div>
</section>
<section id="signing-content">
<h2>Signing Content<a class="headerlink" href="#signing-content" title="Permalink to this heading">¶</a></h2>
<p>The way that <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> protects content from tampering is by taking
checksums (sha256) of all of the secured files in the project, compiling those
into a checksum manifest file, and then finally signing that manifest file.</p>
<p>Thus, the first step toward signing content is to create a file that tells
<code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> which files to protect. This file should be called
<code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code> and live in the project root directory.</p>
<p>Internally, <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> makes use of the <code class="docutils literal notranslate"><span class="pre">distlib.manifest</span></code> module of
Python’s <a class="reference external" href="https://pypi.org/project/distlib/">distlib</a> library, and thus <code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code> must follow the syntax that
this library specifies. The Python Packaging User Guide has an <a class="reference external" href="https://packaging.python.org/en/latest/guides/using-manifest-in/#manifest-in-commands">explanation of
the MANIFEST.in file directives</a>.</p>
<p>For our sample project, we will include two directives. Our <code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code> will
look like this:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code></span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include</span> <span class="n">inventory</span>
<span class="n">recursive</span><span class="o">-</span><span class="n">include</span> <span class="n">playbooks</span> <span class="o">*.</span><span class="n">yml</span>
</pre></div>
</div>
</div>
<p>With this file in place, we can generate our checksum manifest file and sign
it. These steps both happen in a single <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> command.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">Generating a checksum manifest file and signing it</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ansible-sign project gpg-sign .
[OK   ] GPG signing successful!
[NOTE ] Checksum manifest: ./.ansible-sign/sha256sum.txt
[NOTE ] GPG summary: signature created
</pre></div>
</div>
</div>
<p>Congratulations, you’ve now signed your first project!</p>
<p>Notice that the <code class="docutils literal notranslate"><span class="pre">gpg-sign</span></code> subcommand lives under the <code class="docutils literal notranslate"><span class="pre">project</span></code>
subcommand. For signing project content, every command will start with
<code class="docutils literal notranslate"><span class="pre">ansible-sign</span> <span class="pre">project</span></code>. As noted above, as a rule, every <code class="docutils literal notranslate"><span class="pre">ansible-sign</span>
<span class="pre">project</span></code> command takes the project root directory as its final argument.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>As mentioned earlier, <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> by default makes use of your default
keyring and looks for the first available secret key that it can find, to sign
your project. You can specify a specific secret key to use with the
<code class="docutils literal notranslate"><span class="pre">--fingerprint</span></code> option, or even a completely independent GPG home directory
with the <code class="docutils literal notranslate"><span class="pre">--gnupg-home</span></code> option.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are using a desktop environment, GnuPG will automatically pop up a
dialog asking for your secret key’s passphrase. If this functionality does
not work, or you are working without a desktop environment (e.g., via SSH),
you can use the <code class="docutils literal notranslate"><span class="pre">-p</span></code>/<code class="docutils literal notranslate"><span class="pre">--prompt-passphrase</span></code> flag after <code class="docutils literal notranslate"><span class="pre">gpg-sign</span></code> in the
above command, which will cause <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> to prompt for the password
instead.</p>
</div>
<p>If we now look at the structure of the project directory, we’ll notice that a
new <code class="docutils literal notranslate"><span class="pre">.ansible-sign</span></code> directory has been created. This directory houses the
checksum manifest and a detached GPG signature for it.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">Our sample project after signing</span><a class="headerlink" href="#id8" title="Permalink to this code">¶</a></div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ tree -a .
.
├── .ansible-sign
│   ├── sha256sum.txt
│   └── sha256sum.txt.sig
├── inventory
├── MANIFEST.in
└── playbooks
    ├── get_uptime.yml
    └── hello.yml
</pre></div>
</div>
</div>
</section>
<section id="verifying-content">
<h2>Verifying Content<a class="headerlink" href="#verifying-content" title="Permalink to this heading">¶</a></h2>
<p>If you come in contact with a signed Ansible project and want to verify that it
has not been altered, you can use <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> to check both that the
signature is valid and that the checksums of the files match what the checksum
manifest says they should be. In particular, the <code class="docutils literal notranslate"><span class="pre">ansible-sign</span> <span class="pre">project</span>
<span class="pre">gpg-verify</span></code> command can be used to automatically verify both of these
conditions.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">Verifying our sample project</span><a class="headerlink" href="#id9" title="Permalink to this code">¶</a></div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ ansible-sign project gpg-verify .
<span class="o">[</span>OK   <span class="o">]</span> GPG signature verification succeeded.
<span class="o">[</span>OK   <span class="o">]</span> Checksum validation succeeded.
</pre></div>
</div>
</div>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Once again, by default <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> makes use of your default GPG
keyring to look for a matching public key. You can specify a keyring file
with the <code class="docutils literal notranslate"><span class="pre">--keyring</span></code> option, or a different GPG home with the
<code class="docutils literal notranslate"><span class="pre">--gnugpg-home</span></code> option.</p>
</div>
<p>If verification fails for any reason, some information will be printed to help
you debug the cause. More verbosity can be enabled by passing the global
<code class="docutils literal notranslate"><span class="pre">--debug</span></code> flag, immediately after <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> in your commands.</p>
</section>
<section id="notes-about-automation">
<h2>Notes About Automation<a class="headerlink" href="#notes-about-automation" title="Permalink to this heading">¶</a></h2>
<p>In environments with highly-trusted CI environments, it is possible to automate
the signing process. For example, one might store their GPG private key in a
GitHub Actions secret, and import that into GnuPG in the CI environment. One
could then run through the signing workflow above within the normal CI
workflow/container/environment.</p>
<p>When signing a project using GPG, the environment variable
<code class="docutils literal notranslate"><span class="pre">ANSIBLE_SIGN_GPG_PASSPHRASE</span></code> can be set to the passphrase of the signing
key. This can be injected (and masked/secured) in a CI pipeline.</p>
<p><code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> will return with a different exit-code depending on the
scenario at hand, both during signing and verification. This can also be useful
in the context of CI and automation, as a CI environment can act differently
based on the failure (for example, sending alerts for some errors but silently
failing for others).</p>
<p>These codes are used fairly consistently within the code, and can be considered
stable:</p>
<table class="docutils align-default" id="id10">
<caption><span class="caption-text">Status codes that <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> can exit with</span><a class="headerlink" href="#id10" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 15.0%" />
<col style="width: 35.0%" />
<col style="width: 50.0%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Exit code</p></th>
<th class="head"><p>Approximate meaning</p></th>
<th class="head"><p>Example scenarios</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Success</p></td>
<td><ul class="simple">
<li><p>Signing was successful</p></li>
<li><p>Verification was successful</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>General failure</p></td>
<td><ul class="simple">
<li><p>The checksum manifest file contained a syntax error during verification</p></li>
<li><p>The signature file did not exist during verification</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MANIFEST.in</span></code> did not exist during signing</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Checksum verification failure</p></td>
<td><ul class="simple">
<li><p>The checksum hashes calculated during verification differed from what
was in the signed checksum manifest. (That is, a project file was
changed but the signing process was not recompleted.)</p></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>Signature verification failure</p></td>
<td><ul class="simple">
<li><p>The signer’s public key was not in the user’s GPG keyring</p></li>
<li><p>The wrong GnuPG home directory or keyring file was specified</p></li>
<li><p>The signed checksum manifest file was modified in some way</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>Signing process failure</p></td>
<td><ul class="simple">
<li><p>The signer’s private key was not found in the GPG keyring</p></li>
<li><p>The wrong GnuPG home directory or keyring file was specified</p></li>
</ul>
</td>
</tr>
</tbody>
</table>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">ansible-sign</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Rundown (CLI Tutorial)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#adding-a-gpg-key-to-awx-or-ansible-automation-controller">Adding a GPG key to AWX or Ansible Automation Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-to-access-the-ansible-sign-cli-utility">How to Access the <code class="docutils literal notranslate"><span class="pre">ansible-sign</span></code> CLI Utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-project-directory">The Project Directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#signing-content">Signing Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="#verifying-content">Verifying Content</a></li>
<li class="toctree-l2"><a class="reference internal" href="#notes-about-automation">Notes About Automation</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="changelog.html" title="previous chapter">Changelog</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Red Hat, Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.2.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/rundown.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>